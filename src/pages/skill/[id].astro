---
import Layout from '../../layouts/Layout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const skills = await getCollection('skills');
  const sorted = skills.sort((a, b) => a.data.id.localeCompare(b.data.id));
  return sorted.map((skill, i) => ({
    params: { id: skill.data.id },
    props: {
      skill,
      prev: i > 0 ? sorted[i - 1].data : null,
      next: i < sorted.length - 1 ? sorted[i + 1].data : null,
    },
  }));
}

const { skill, prev, next } = Astro.props;
const { Content } = await render(skill);

const categoryNames: Record<string, string> = {
  P1: 'Prompt Injection',
  P2: 'Data Exfiltration',
  P3: 'Privilege Escalation',
  P4: 'Malicious Scripts',
  P5: 'Config Tampering',
  P6: 'Social Engineering',
  P7: 'Supply Chain',
};
---

<Layout title={`${skill.data.id}: ${skill.data.title} â€” TroySkills`} description={`${skill.data.id}: ${skill.data.title}. ${skill.data.severity} severity ${categoryNames[skill.data.category]} attack pattern. ${skill.data.description}`}>
  <!-- JSON-LD Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": `${skill.data.id}: ${skill.data.title}`,
    "description": skill.data.description,
    "datePublished": skill.data.date,
    "author": { "@type": "Organization", "name": "TroySkills", "url": "https://troyskills.ai" },
    "publisher": { "@type": "Organization", "name": "TroySkills", "url": "https://troyskills.ai" },
    "mainEntityOfPage": `https://troyskills.ai/skill/${skill.data.id}`,
    "keywords": skill.data.tags?.join(", "),
    "articleSection": `${skill.data.category}: ${categoryNames[skill.data.category]}`
  })} />
  <article class="max-w-4xl mx-auto px-4 py-12">
    <Breadcrumb items={[
      { label: 'Database', href: '/database' },
      { label: `${skill.data.id}: ${skill.data.title}` },
    ]} />

    <div class="mb-8">
      <div class="flex items-center gap-3 mb-3 flex-wrap">
        <button class="copy-id-btn text-sm font-mono text-red-400 bg-red-500/10 px-2 py-1 rounded cursor-pointer hover:bg-red-500/20 transition-colors" data-id={skill.data.id} title="Click to copy ID">
          {skill.data.id} ğŸ“‹
        </button>
        <span class={`text-xs px-2 py-1 rounded-full ${
          skill.data.severity === 'Critical' ? 'bg-red-500/20 text-red-400' :
          skill.data.severity === 'High' ? 'bg-orange-500/20 text-orange-400' :
          skill.data.severity === 'Medium' ? 'bg-yellow-500/20 text-yellow-400' :
          'bg-green-500/20 text-green-400'
        }`}>{skill.data.severity}</span>
        <span class="text-xs bg-slate-800 px-2 py-1 rounded-full">{skill.data.category}: {categoryNames[skill.data.category]}</span>
      </div>
      <h1 class="text-2xl md:text-3xl font-bold mb-3">{skill.data.title}</h1>
      <p class="text-slate-400">{skill.data.description}</p>
      <div class="flex gap-2 mt-4 flex-wrap">
        {skill.data.tags?.map((tag: string) => (
          <span class="text-xs bg-slate-800 text-slate-400 px-2 py-1 rounded">#{tag}</span>
        ))}
      </div>
      <div class="flex items-center gap-4 mt-4 text-xs text-slate-600 flex-wrap">
        <span>Published: {skill.data.date}</span>
        <button class="share-btn inline-flex items-center gap-1 text-slate-500 hover:text-red-400 transition-colors cursor-pointer" data-title={`${skill.data.id}: ${skill.data.title}`} data-url={`https://troyskills.ai/skill/${skill.data.id}`}>
          ğŸ”— Share
        </button>
        <a href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(`${skill.data.id}: ${skill.data.title} â€” AI Agent Attack Pattern`)}&url=${encodeURIComponent(`https://troyskills.ai/skill/${skill.data.id}`)}`} target="_blank" class="text-slate-500 hover:text-red-400 transition-colors">
          ğ• Tweet
        </a>
      </div>
    </div>

    <div class="prose prose-invert prose-red max-w-none
      prose-headings:text-slate-100 prose-p:text-slate-300
      prose-code:text-red-400 prose-pre:bg-slate-900 prose-pre:border prose-pre:border-slate-800
      prose-a:text-red-400 prose-strong:text-slate-200">
      <Content />
    </div>

    <!-- Prev/Next Navigation -->
    <nav class="mt-12 pt-8 border-t border-slate-800 grid grid-cols-1 sm:grid-cols-2 gap-4">
      {prev ? (
        <a href={`/skill/${prev.id}`} class="bg-slate-900 border border-slate-800 rounded-xl p-4 hover:border-red-500/50 transition-colors group">
          <div class="text-xs text-slate-500 mb-1">â† Previous</div>
          <div class="text-sm font-mono text-red-400">{prev.id}</div>
          <div class="text-sm font-medium group-hover:text-red-400 transition-colors truncate">{prev.title}</div>
        </a>
      ) : <div />}
      {next ? (
        <a href={`/skill/${next.id}`} class="bg-slate-900 border border-slate-800 rounded-xl p-4 hover:border-red-500/50 transition-colors group text-right sm:text-right">
          <div class="text-xs text-slate-500 mb-1">Next â†’</div>
          <div class="text-sm font-mono text-red-400">{next.id}</div>
          <div class="text-sm font-medium group-hover:text-red-400 transition-colors truncate">{next.title}</div>
        </a>
      ) : <div />}
    </nav>
  </article>

  <script>
    document.querySelectorAll('.copy-id-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = (btn as HTMLElement).dataset.id;
        if (id) {
          await navigator.clipboard.writeText(id);
          const original = btn.textContent;
          btn.textContent = 'âœ“ Copied!';
          setTimeout(() => { btn.textContent = original; }, 1500);
        }
      });
    });
    document.querySelectorAll('.share-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const el = btn as HTMLElement;
        const title = el.dataset.title || '';
        const url = el.dataset.url || '';
        if (navigator.share) {
          await navigator.share({ title, url });
        } else {
          await navigator.clipboard.writeText(url);
          const original = btn.innerHTML;
          btn.textContent = 'âœ“ Link copied!';
          setTimeout(() => { btn.innerHTML = original; }, 1500);
        }
      });
    });
  </script>
</Layout>
