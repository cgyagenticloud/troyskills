---
import Layout from '../../layouts/Layout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const skills = await getCollection('skills');
  return skills.map(skill => ({
    params: { id: skill.data.id },
    props: { skill },
  }));
}

const { skill } = Astro.props;
const { Content } = await render(skill);

const categoryNames: Record<string, string> = {
  P1: 'Prompt Injection',
  P2: 'Data Exfiltration',
  P3: 'Privilege Escalation',
  P4: 'Malicious Scripts',
  P5: 'Config Tampering',
  P6: 'Social Engineering',
  P7: 'Supply Chain',
};
---

<Layout title={`${skill.data.id}: ${skill.data.title} â€” TroySkills`}>
  <article class="max-w-4xl mx-auto px-4 py-12">
    <a href="/database" class="text-sm text-slate-500 hover:text-red-400 transition-colors mb-6 inline-block">â† Back to Database</a>

    <div class="mb-8">
      <div class="flex items-center gap-3 mb-3 flex-wrap">
        <button class="copy-id-btn text-sm font-mono text-red-400 bg-red-500/10 px-2 py-1 rounded cursor-pointer hover:bg-red-500/20 transition-colors" data-id={skill.data.id} title="Click to copy ID">
          {skill.data.id} ğŸ“‹
        </button>
        <span class={`text-xs px-2 py-1 rounded-full ${
          skill.data.severity === 'Critical' ? 'bg-red-500/20 text-red-400' :
          skill.data.severity === 'High' ? 'bg-orange-500/20 text-orange-400' :
          'bg-yellow-500/20 text-yellow-400'
        }`}>{skill.data.severity}</span>
        <span class="text-xs bg-slate-800 px-2 py-1 rounded-full">{skill.data.category}: {categoryNames[skill.data.category]}</span>
      </div>
      <h1 class="text-3xl font-bold mb-3">{skill.data.title}</h1>
      <p class="text-slate-400">{skill.data.description}</p>
      <div class="flex gap-2 mt-4">
        {skill.data.tags?.map((tag: string) => (
          <span class="text-xs bg-slate-800 text-slate-400 px-2 py-1 rounded">#{tag}</span>
        ))}
      </div>
      <div class="flex items-center gap-4 mt-4 text-xs text-slate-600">
        <span>Published: {skill.data.date}</span>
        <button class="share-btn inline-flex items-center gap-1 text-slate-500 hover:text-red-400 transition-colors cursor-pointer" data-title={`${skill.data.id}: ${skill.data.title}`} data-url={`https://troyskills.ai/skill/${skill.data.id}`}>
          ğŸ”— Share
        </button>
        <a href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(`${skill.data.id}: ${skill.data.title} â€” AI Agent Attack Pattern`)}&url=${encodeURIComponent(`https://troyskills.ai/skill/${skill.data.id}`)}`} target="_blank" class="text-slate-500 hover:text-red-400 transition-colors">
          ğ• Tweet
        </a>
      </div>
    </div>

    <div class="prose prose-invert prose-red max-w-none
      prose-headings:text-slate-100 prose-p:text-slate-300
      prose-code:text-red-400 prose-pre:bg-slate-900 prose-pre:border prose-pre:border-slate-800
      prose-a:text-red-400 prose-strong:text-slate-200">
      <Content />
    </div>
  </article>

  <script>
    // Copy ID to clipboard
    document.querySelectorAll('.copy-id-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = (btn as HTMLElement).dataset.id;
        if (id) {
          await navigator.clipboard.writeText(id);
          const original = btn.textContent;
          btn.textContent = 'âœ“ Copied!';
          setTimeout(() => { btn.textContent = original; }, 1500);
        }
      });
    });

    // Share button
    document.querySelectorAll('.share-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const el = btn as HTMLElement;
        const title = el.dataset.title || '';
        const url = el.dataset.url || '';
        if (navigator.share) {
          await navigator.share({ title, url });
        } else {
          await navigator.clipboard.writeText(url);
          const original = btn.innerHTML;
          btn.textContent = 'âœ“ Link copied!';
          setTimeout(() => { btn.innerHTML = original; }, 1500);
        }
      });
    });
  </script>
</Layout>
