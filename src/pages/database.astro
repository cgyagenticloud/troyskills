---
import Layout from '../layouts/Layout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import { getCollection } from 'astro:content';

const skills = await getCollection('skills');
const sorted = skills.sort((a, b) => a.data.id.localeCompare(b.data.id));

const categories = [
  { id: 'P1', name: 'Prompt Injection', icon: 'ğŸ’‰' },
  { id: 'P2', name: 'Data Exfiltration', icon: 'ğŸ“¤' },
  { id: 'P3', name: 'Privilege Escalation', icon: 'ğŸ”“' },
  { id: 'P4', name: 'Malicious Scripts', icon: 'ğŸ' },
  { id: 'P5', name: 'Config Tampering', icon: 'âš™ï¸' },
  { id: 'P6', name: 'Social Engineering', icon: 'ğŸ­' },
  { id: 'P7', name: 'Supply Chain', icon: 'ğŸ“¦' },
];

const severities = ['Critical', 'High', 'Medium'];
---

<Layout title="Database â€” TroySkills">
  <section class="max-w-6xl mx-auto px-4 py-12">
    <Breadcrumb items={[{ label: "Database" }]} />
    <h1 class="text-3xl font-bold mb-2">Attack Pattern Database</h1>
    <p class="text-slate-400 mb-8">All {sorted.length} documented malicious AI agent skill patterns.</p>

    <!-- Search -->
    <div class="mb-6">
      <input
        type="text"
        id="search"
        placeholder="Search patterns... (e.g., prompt injection, exfiltration)"
        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-slate-100 placeholder-slate-500 focus:border-red-500 focus:outline-none"
      />
    </div>

    <!-- Category Filters -->
    <div class="mb-4">
      <div class="text-xs text-slate-500 uppercase tracking-wider mb-2">Category</div>
      <div class="flex flex-wrap gap-2">
        <button class="filter-cat active text-xs px-3 py-1.5 rounded-full border border-slate-700 bg-slate-800 text-slate-300 hover:border-red-500/50 transition-colors" data-cat="all">All</button>
        {categories.map(cat => (
          <button class="filter-cat text-xs px-3 py-1.5 rounded-full border border-slate-700 bg-slate-900 text-slate-400 hover:border-red-500/50 transition-colors" data-cat={cat.id}>
            {cat.icon} {cat.id}
          </button>
        ))}
      </div>
    </div>

    <!-- Severity Filters -->
    <div class="mb-8">
      <div class="text-xs text-slate-500 uppercase tracking-wider mb-2">Severity</div>
      <div class="flex flex-wrap gap-2">
        <button class="filter-sev active text-xs px-3 py-1.5 rounded-full border border-slate-700 bg-slate-800 text-slate-300 hover:border-red-500/50 transition-colors" data-sev="all">All</button>
        <button class="filter-sev text-xs px-3 py-1.5 rounded-full border border-slate-700 bg-slate-900 text-red-400 hover:border-red-500/50 transition-colors" data-sev="Critical">ğŸ”´ Critical</button>
        <button class="filter-sev text-xs px-3 py-1.5 rounded-full border border-slate-700 bg-slate-900 text-orange-400 hover:border-red-500/50 transition-colors" data-sev="High">ğŸŸ  High</button>
        <button class="filter-sev text-xs px-3 py-1.5 rounded-full border border-slate-700 bg-slate-900 text-yellow-400 hover:border-red-500/50 transition-colors" data-sev="Medium">ğŸŸ¡ Medium</button>
      </div>
    </div>

    <!-- Results count -->
    <div class="text-sm text-slate-500 mb-4" id="results-count">Showing {sorted.length} patterns</div>

    <!-- Table -->
    <div class="space-y-3" id="skill-list">
      {sorted.map(skill => (
        <a href={`/skill/${skill.data.id}`} class="skill-item block bg-slate-900 border border-slate-800 rounded-xl p-5 hover:border-red-500/50 transition-colors"
           data-search={`${skill.data.id} ${skill.data.title} ${skill.data.category} ${skill.data.description} ${(skill.data.tags || []).join(' ')}`.toLowerCase()}
           data-cat={skill.data.category}
           data-sev={skill.data.severity}>
          <div class="flex items-center justify-between flex-wrap gap-2">
            <div>
              <span class="text-xs font-mono text-red-400 mr-3">{skill.data.id}</span>
              <span class="font-semibold">{skill.data.title}</span>
            </div>
            <div class="flex items-center gap-3">
              <span class={`text-xs px-2 py-1 rounded-full ${
                skill.data.severity === 'Critical' ? 'bg-red-500/20 text-red-400' :
                skill.data.severity === 'High' ? 'bg-orange-500/20 text-orange-400' :
                'bg-yellow-500/20 text-yellow-400'
              }`}>{skill.data.severity}</span>
              <span class="text-xs bg-slate-800 px-2 py-1 rounded-full">{skill.data.category}</span>
              <span class="text-xs text-slate-500">{skill.data.date}</span>
            </div>
          </div>
          <p class="text-sm text-slate-400 mt-2">{skill.data.description}</p>
        </a>
      ))}
    </div>
  </section>

  <script>
    const search = document.getElementById('search') as HTMLInputElement;
    const items = document.querySelectorAll('.skill-item');
    const catBtns = document.querySelectorAll('.filter-cat');
    const sevBtns = document.querySelectorAll('.filter-sev');
    const countEl = document.getElementById('results-count');

    let activeCat = 'all';
    let activeSev = 'all';

    function applyFilters() {
      const q = search?.value.toLowerCase().trim() || '';
      let visible = 0;
      items.forEach(item => {
        const el = item as HTMLElement;
        const matchSearch = !q || (el.dataset.search || '').includes(q);
        const matchCat = activeCat === 'all' || el.dataset.cat === activeCat;
        const matchSev = activeSev === 'all' || el.dataset.sev === activeSev;
        const show = matchSearch && matchCat && matchSev;
        el.style.display = show ? '' : 'none';
        if (show) visible++;
      });
      if (countEl) countEl.textContent = `Showing ${visible} pattern${visible !== 1 ? 's' : ''}`;
    }

    function setActive(btns: NodeListOf<Element>, activeBtn: Element) {
      btns.forEach(b => {
        b.classList.remove('active', 'bg-slate-800', 'text-slate-300');
        b.classList.add('bg-slate-900');
      });
      activeBtn.classList.add('active', 'bg-slate-800', 'text-slate-300');
      activeBtn.classList.remove('bg-slate-900');
    }

    catBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        activeCat = (btn as HTMLElement).dataset.cat || 'all';
        setActive(catBtns, btn);
        applyFilters();
      });
    });

    sevBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        activeSev = (btn as HTMLElement).dataset.sev || 'all';
        setActive(sevBtns, btn);
        applyFilters();
      });
    });

    search?.addEventListener('input', applyFilters);
  </script>
</Layout>
