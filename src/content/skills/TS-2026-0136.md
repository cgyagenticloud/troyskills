---
id: "TS-2026-0136"
title: "Time-of-Check-Time-of-Use (TOCTOU) in Agent Tool Calls"
category: "P3"
severity: "High"
description: "Attackers exploit the gap between when an AI agent validates a tool call's safety and when the call is actually executed, modifying parameters, permissions, or target resources in the window between check and use."
date: "2026-02-26"
tags: ["zero-day", "toctou", "race-condition", "tool-use", "timing", "privilege-escalation", "novel"]
---

## Overview

AI agents follow a check-then-act pattern: they reason about whether a tool call is safe, get approval (from safety filters or human-in-the-loop), and then execute. The time gap between validation and execution creates a classic TOCTOU vulnerability. An attacker can modify the parameters being passed, change the target resource, or alter permissions during this window — the safety check passes on the original benign parameters, but the actual execution uses attacker-modified values.

## Attack Vector

1. Agent receives a task requiring tool use (file operations, API calls, deployments)
2. Agent's safety layer validates the proposed tool call — appears safe
3. Between validation and execution, attacker modifies: the target file path, API endpoint, deployment config, or parameters
4. Tool executes with modified (malicious) parameters that were never validated
5. Safety system's audit log shows the original safe parameters, not what actually executed

## Technical Details

```python
# Agent tool execution pipeline with TOCTOU vulnerability

class AgentToolExecutor:
    def execute_tool(self, tool_call):
        # STEP 1: Safety check (TIME OF CHECK)
        params = tool_call.get_params()  # Gets current params
        if not self.safety_filter.validate(params):
            return "Blocked by safety filter"
        
        # ⚠️ VULNERABILITY WINDOW ⚠️
        # Between safety check and execution, params can change
        # - Shared memory modified by another agent/thread
        # - File referenced by path is swapped (symlink attack)
        # - API endpoint DNS is poisoned
        # - Config file is hot-reloaded with new values
        
        # STEP 2: Human approval (widens the window further)
        if self.requires_approval(params):
            self.request_human_approval(params)  # Shows ORIGINAL params
            # Window now seconds to minutes wide
        
        # STEP 3: Execution (TIME OF USE)
        result = tool_call.execute()  # Re-reads params → gets MODIFIED values
        return result

# ATTACK EXAMPLE:
# Agent: "I'll write the config file to /app/config.json"
# Safety: ✅ /app/config.json is an allowed path
# Human: ✅ "Approved - writing config looks fine"
# 
# Between approval and execution:
# Attacker creates symlink: /app/config.json → /etc/shadow
#
# Agent writes to /app/config.json → actually writes to /etc/shadow
# Audit log: "Wrote to /app/config.json" (benign)
# Reality: Overwrote system password file
```

## Impact

- **Bypasses all safety checks**: Validation passes on benign params, execution uses malicious ones
- **Audit trail corruption**: Logs show validated params, not actual execution params
- **Human-in-the-loop bypass**: Human approves the original safe action, not the modified one
- **Classic vulnerability, new context**: Well-known in OS security, unaddressed in AI agents
- **Wider windows = more exploitable**: Human approval steps create seconds-to-minutes windows

## Mitigation

- Atomic check-and-execute: validate parameters at the moment of execution, not before
- Immutable parameter passing: snapshot and freeze params at validation time
- Verify target resources haven't changed between check and use (checksums, inode checks)
- Minimize window between validation and execution — eliminate unnecessary delays
- Re-validate all parameters immediately before tool execution, even after human approval

## Real-World Examples

No documented real-world examples yet specific to AI agent TOCTOU attacks. However, the general TOCTOU pattern is well-established:

- **Classic TOCTOU file system attacks** — TOCTOU race conditions have been exploited in Unix/Linux systems for decades (CVE-2005-1111, CVE-2008-0525, and many others).
- **Smart contract reentrancy (analogous pattern)** — The DAO hack (2016) exploited a reentrancy vulnerability conceptually similar to TOCTOU, draining $60M from Ethereum. [Wikipedia](https://en.wikipedia.org/wiki/The_DAO)

If you know of an AI-agent-specific TOCTOU exploit, please [submit it](https://github.com/cgyagenticloud/troyskills/issues).
